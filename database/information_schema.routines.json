[
  {
    "routine_name": "award_user_badges",
    "routine_type": "FUNCTION",
    "return_type": "void",
    "routine_definition": "\r\nDECLARE\r\n    v_stats user_stats%ROWTYPE;\r\nBEGIN\r\n    SELECT * INTO v_stats FROM user_stats WHERE user_id = p_user_id;\r\n    \r\n    -- First Case badge\r\n    IF v_stats.total_cases >= 1 THEN\r\n        INSERT INTO user_badges (user_id, badge_id, badge_name, badge_description, badge_icon, badge_tier)\r\n        VALUES (p_user_id, 'first_case', 'First Timer', 'Settled your first dispute', 'ðŸŽ¯', 'bronze')\r\n        ON CONFLICT DO NOTHING;\r\n    END IF;\r\n    \r\n    -- Win Streak badges\r\n    IF v_stats.longest_win_streak >= 3 THEN\r\n        INSERT INTO user_badges (user_id, badge_id, badge_name, badge_description, badge_icon, badge_tier)\r\n        VALUES (p_user_id, 'streak_3', 'On Fire', '3 wins in a row', 'ðŸ”¥', 'bronze')\r\n        ON CONFLICT DO NOTHING;\r\n    END IF;\r\n    \r\n    IF v_stats.longest_win_streak >= 5 THEN\r\n        INSERT INTO user_badges (user_id, badge_id, badge_name, badge_description, badge_icon, badge_tier)\r\n        VALUES (p_user_id, 'streak_5', 'Unstoppable', '5 wins in a row', 'ðŸ”¥', 'silver')\r\n        ON CONFLICT DO NOTHING;\r\n    END IF;\r\n    \r\n    IF v_stats.longest_win_streak >= 10 THEN\r\n        INSERT INTO user_badges (user_id, badge_id, badge_name, badge_description, badge_icon, badge_tier)\r\n        VALUES (p_user_id, 'streak_10', 'Legendary', '10 wins in a row', 'ðŸ”¥', 'gold')\r\n        ON CONFLICT DO NOTHING;\r\n    END IF;\r\n    \r\n    -- Total wins badges\r\n    IF v_stats.total_wins >= 5 THEN\r\n        INSERT INTO user_badges (user_id, badge_id, badge_name, badge_description, badge_icon, badge_tier)\r\n        VALUES (p_user_id, 'wins_5', 'Winner', '5 total wins', 'ðŸ†', 'bronze')\r\n        ON CONFLICT DO NOTHING;\r\n    END IF;\r\n    \r\n    IF v_stats.total_wins >= 25 THEN\r\n        INSERT INTO user_badges (user_id, badge_id, badge_name, badge_description, badge_icon, badge_tier)\r\n        VALUES (p_user_id, 'wins_25', 'Champion', '25 total wins', 'ðŸ†', 'silver')\r\n        ON CONFLICT DO NOTHING;\r\n    END IF;\r\n    \r\n    IF v_stats.total_wins >= 100 THEN\r\n        INSERT INTO user_badges (user_id, badge_id, badge_name, badge_description, badge_icon, badge_tier)\r\n        VALUES (p_user_id, 'wins_100', 'Grand Champion', '100 total wins', 'ðŸ†', 'gold')\r\n        ON CONFLICT DO NOTHING;\r\n    END IF;\r\n    \r\n    -- Evidence Expert badges\r\n    IF v_stats.cases_with_evidence >= 5 AND v_stats.evidence_win_rate >= 70 THEN\r\n        INSERT INTO user_badges (user_id, badge_id, badge_name, badge_description, badge_icon, badge_tier)\r\n        VALUES (p_user_id, 'evidence_expert', 'Evidence Expert', 'Win 70%+ of cases with evidence', 'ðŸ“Ž', 'bronze')\r\n        ON CONFLICT DO NOTHING;\r\n    END IF;\r\n    \r\n    IF v_stats.cases_with_evidence >= 20 AND v_stats.evidence_win_rate >= 80 THEN\r\n        INSERT INTO user_badges (user_id, badge_id, badge_name, badge_description, badge_icon, badge_tier)\r\n        VALUES (p_user_id, 'evidence_master', 'Evidence Master', 'Win 80%+ of cases with evidence (20+ cases)', 'ðŸ“Ž', 'gold')\r\n        ON CONFLICT DO NOTHING;\r\n    END IF;\r\n    \r\n    -- High score badges\r\n    IF v_stats.avg_score >= 75 AND v_stats.total_cases >= 5 THEN\r\n        INSERT INTO user_badges (user_id, badge_id, badge_name, badge_description, badge_icon, badge_tier)\r\n        VALUES (p_user_id, 'high_scorer', 'Strong Arguments', 'Average score 75+ (5+ cases)', 'ðŸ’ª', 'bronze')\r\n        ON CONFLICT DO NOTHING;\r\n    END IF;\r\n    \r\n    IF v_stats.avg_score >= 85 AND v_stats.total_cases >= 10 THEN\r\n        INSERT INTO user_badges (user_id, badge_id, badge_name, badge_description, badge_icon, badge_tier)\r\n        VALUES (p_user_id, 'master_debater', 'Master Debater', 'Average score 85+ (10+ cases)', 'ðŸ’ª', 'gold')\r\n        ON CONFLICT DO NOTHING;\r\n    END IF;\r\n    \r\n    -- Compromise Champion (draws)\r\n    IF v_stats.total_draws >= 3 THEN\r\n        INSERT INTO user_badges (user_id, badge_id, badge_name, badge_description, badge_icon, badge_tier)\r\n        VALUES (p_user_id, 'compromise_champion', 'Compromise Champion', 'Reached 3 draws - sometimes both are right!', 'ðŸ¤', 'bronze')\r\n        ON CONFLICT DO NOTHING;\r\n    END IF;\r\n    \r\n    -- Category specialist badges\r\n    IF (v_stats.category_stats -> 'relationship' ->> 'wins')::int >= 10 THEN\r\n        INSERT INTO user_badges (user_id, badge_id, badge_name, badge_description, badge_icon, badge_tier)\r\n        VALUES (p_user_id, 'relationship_guru', 'Relationship Guru', '10 wins in relationship disputes', 'ðŸ’•', 'silver')\r\n        ON CONFLICT DO NOTHING;\r\n    END IF;\r\n    \r\n    IF (v_stats.category_stats -> 'tech' ->> 'wins')::int >= 10 THEN\r\n        INSERT INTO user_badges (user_id, badge_id, badge_name, badge_description, badge_icon, badge_tier)\r\n        VALUES (p_user_id, 'tech_titan', 'Tech Titan', '10 wins in tech disputes', 'ðŸ’»', 'silver')\r\n        ON CONFLICT DO NOTHING;\r\n    END IF;\r\n    \r\n    -- Veteran badge\r\n    IF v_stats.total_cases >= 50 THEN\r\n        INSERT INTO user_badges (user_id, badge_id, badge_name, badge_description, badge_icon, badge_tier)\r\n        VALUES (p_user_id, 'veteran', 'Veteran Arguer', '50 total cases settled', 'â­', 'gold')\r\n        ON CONFLICT DO NOTHING;\r\n    END IF;\r\n    \r\n    -- Clean Fighter (low fallacies)\r\n    IF v_stats.total_cases >= 10 AND (v_stats.total_fallacies_detected::decimal / v_stats.total_cases) < 1 THEN\r\n        INSERT INTO user_badges (user_id, badge_id, badge_name, badge_description, badge_icon, badge_tier)\r\n        VALUES (p_user_id, 'clean_fighter', 'Clean Fighter', 'Less than 1 fallacy per case average', 'âœ¨', 'silver')\r\n        ON CONFLICT DO NOTHING;\r\n    END IF;\r\nEND;\r\n"
  },
  {
    "routine_name": "can_party_appeal",
    "routine_type": "FUNCTION",
    "return_type": "boolean",
    "routine_definition": "\r\nDECLARE\r\n    v_case_status VARCHAR(20);\r\n    v_already_appealed BOOLEAN;\r\nBEGIN\r\n    -- Check case exists and is complete\r\n    SELECT status INTO v_case_status\r\n    FROM cases\r\n    WHERE id = p_case_id;\r\n    \r\n    IF v_case_status IS NULL THEN\r\n        RETURN FALSE;\r\n    END IF;\r\n    \r\n    IF v_case_status != 'complete' THEN\r\n        RETURN FALSE;\r\n    END IF;\r\n    \r\n    -- Check if party already appealed\r\n    SELECT EXISTS(\r\n        SELECT 1 FROM appeals\r\n        WHERE case_id = p_case_id\r\n        AND appealing_party = p_party\r\n    ) INTO v_already_appealed;\r\n    \r\n    RETURN NOT v_already_appealed;\r\nEND;\r\n"
  },
  {
    "routine_name": "check_and_award_badges",
    "routine_type": "FUNCTION",
    "return_type": "void",
    "routine_definition": "\r\nDECLARE\r\n    v_stats user_stats%ROWTYPE;\r\nBEGIN\r\n    SELECT * INTO v_stats FROM user_stats WHERE user_id = p_user_id;\r\n    \r\n    -- First Case badge\r\n    IF v_stats.total_cases >= 1 THEN\r\n        INSERT INTO user_badges (user_id, badge_id, badge_name, badge_description, badge_icon, badge_tier)\r\n        VALUES (p_user_id, 'first_case', 'First Timer', 'Settled your first dispute', 'ðŸŽ¯', 'bronze')\r\n        ON CONFLICT DO NOTHING;\r\n    END IF;\r\n    \r\n    -- Win Streak badges\r\n    IF v_stats.longest_streak >= 3 THEN\r\n        INSERT INTO user_badges (user_id, badge_id, badge_name, badge_description, badge_icon, badge_tier)\r\n        VALUES (p_user_id, 'streak_3', 'On Fire', '3 wins in a row', 'ðŸ”¥', 'bronze')\r\n        ON CONFLICT DO NOTHING;\r\n    END IF;\r\n    \r\n    IF v_stats.longest_streak >= 5 THEN\r\n        INSERT INTO user_badges (user_id, badge_id, badge_name, badge_description, badge_icon, badge_tier)\r\n        VALUES (p_user_id, 'streak_5', 'Unstoppable', '5 wins in a row', 'ðŸ”¥', 'silver')\r\n        ON CONFLICT DO NOTHING;\r\n    END IF;\r\n    \r\n    IF v_stats.longest_streak >= 10 THEN\r\n        INSERT INTO user_badges (user_id, badge_id, badge_name, badge_description, badge_icon, badge_tier)\r\n        VALUES (p_user_id, 'streak_10', 'Legendary', '10 wins in a row', 'ðŸ”¥', 'gold')\r\n        ON CONFLICT DO NOTHING;\r\n    END IF;\r\n    \r\n    -- Total wins badges\r\n    IF v_stats.total_wins >= 5 THEN\r\n        INSERT INTO user_badges (user_id, badge_id, badge_name, badge_description, badge_icon, badge_tier)\r\n        VALUES (p_user_id, 'wins_5', 'Winner', '5 total wins', 'ðŸ†', 'bronze')\r\n        ON CONFLICT DO NOTHING;\r\n    END IF;\r\n    \r\n    IF v_stats.total_wins >= 25 THEN\r\n        INSERT INTO user_badges (user_id, badge_id, badge_name, badge_description, badge_icon, badge_tier)\r\n        VALUES (p_user_id, 'wins_25', 'Champion', '25 total wins', 'ðŸ†', 'silver')\r\n        ON CONFLICT DO NOTHING;\r\n    END IF;\r\n    \r\n    IF v_stats.total_wins >= 100 THEN\r\n        INSERT INTO user_badges (user_id, badge_id, badge_name, badge_description, badge_icon, badge_tier)\r\n        VALUES (p_user_id, 'wins_100', 'Grand Champion', '100 total wins', 'ðŸ†', 'gold')\r\n        ON CONFLICT DO NOTHING;\r\n    END IF;\r\n    \r\n    -- Evidence Expert badges\r\n    IF v_stats.cases_with_evidence >= 5 AND v_stats.evidence_win_rate >= 70 THEN\r\n        INSERT INTO user_badges (user_id, badge_id, badge_name, badge_description, badge_icon, badge_tier)\r\n        VALUES (p_user_id, 'evidence_expert', 'Evidence Expert', 'Win 70%+ of cases with evidence', 'ðŸ“Ž', 'bronze')\r\n        ON CONFLICT DO NOTHING;\r\n    END IF;\r\n    \r\n    IF v_stats.cases_with_evidence >= 20 AND v_stats.evidence_win_rate >= 80 THEN\r\n        INSERT INTO user_badges (user_id, badge_id, badge_name, badge_description, badge_icon, badge_tier)\r\n        VALUES (p_user_id, 'evidence_master', 'Evidence Master', 'Win 80%+ of cases with evidence (20+ cases)', 'ðŸ“Ž', 'gold')\r\n        ON CONFLICT DO NOTHING;\r\n    END IF;\r\n    \r\n    -- High score badges\r\n    IF v_stats.avg_score >= 75 AND v_stats.total_cases >= 5 THEN\r\n        INSERT INTO user_badges (user_id, badge_id, badge_name, badge_description, badge_icon, badge_tier)\r\n        VALUES (p_user_id, 'high_scorer', 'Strong Arguments', 'Average score 75+ (5+ cases)', 'ðŸ’ª', 'bronze')\r\n        ON CONFLICT DO NOTHING;\r\n    END IF;\r\n    \r\n    IF v_stats.avg_score >= 85 AND v_stats.total_cases >= 10 THEN\r\n        INSERT INTO user_badges (user_id, badge_id, badge_name, badge_description, badge_icon, badge_tier)\r\n        VALUES (p_user_id, 'master_debater', 'Master Debater', 'Average score 85+ (10+ cases)', 'ðŸ’ª', 'gold')\r\n        ON CONFLICT DO NOTHING;\r\n    END IF;\r\n    \r\n    -- Compromise Champion (draws)\r\n    IF v_stats.total_draws >= 3 THEN\r\n        INSERT INTO user_badges (user_id, badge_id, badge_name, badge_description, badge_icon, badge_tier)\r\n        VALUES (p_user_id, 'compromise_champion', 'Compromise Champion', 'Reached 3 draws - sometimes both are right!', 'ðŸ¤', 'bronze')\r\n        ON CONFLICT DO NOTHING;\r\n    END IF;\r\n    \r\n    -- Category specialist badges\r\n    IF (v_stats.category_stats -> 'relationship' ->> 'wins')::int >= 10 THEN\r\n        INSERT INTO user_badges (user_id, badge_id, badge_name, badge_description, badge_icon, badge_tier)\r\n        VALUES (p_user_id, 'relationship_guru', 'Relationship Guru', '10 wins in relationship disputes', 'ðŸ’•', 'silver')\r\n        ON CONFLICT DO NOTHING;\r\n    END IF;\r\n    \r\n    IF (v_stats.category_stats -> 'tech' ->> 'wins')::int >= 10 THEN\r\n        INSERT INTO user_badges (user_id, badge_id, badge_name, badge_description, badge_icon, badge_tier)\r\n        VALUES (p_user_id, 'tech_titan', 'Tech Titan', '10 wins in tech disputes', 'ðŸ’»', 'silver')\r\n        ON CONFLICT DO NOTHING;\r\n    END IF;\r\n    \r\n    -- Veteran badge\r\n    IF v_stats.total_cases >= 50 THEN\r\n        INSERT INTO user_badges (user_id, badge_id, badge_name, badge_description, badge_icon, badge_tier)\r\n        VALUES (p_user_id, 'veteran', 'Veteran Arguer', '50 total cases settled', 'â­', 'gold')\r\n        ON CONFLICT DO NOTHING;\r\n    END IF;\r\n    \r\n    -- Clean Fighter (low fallacies)\r\n    IF v_stats.total_cases >= 10 AND (v_stats.total_fallacies_detected::decimal / v_stats.total_cases) < 1 THEN\r\n        INSERT INTO user_badges (user_id, badge_id, badge_name, badge_description, badge_icon, badge_tier)\r\n        VALUES (p_user_id, 'clean_fighter', 'Clean Fighter', 'Less than 1 fallacy per case average', 'âœ¨', 'silver')\r\n        ON CONFLICT DO NOTHING;\r\n    END IF;\r\nEND;\r\n"
  },
  {
    "routine_name": "check_guest_quota",
    "routine_type": "FUNCTION",
    "return_type": "record",
    "routine_definition": "\r\nDECLARE\r\n    usage_count INT;\r\nBEGIN\r\n    SELECT COUNT(*) INTO usage_count\r\n    FROM verdict_usage\r\n    WHERE guest_ip = p_ip;\r\n    \r\n    RETURN QUERY SELECT \r\n        usage_count < 1,\r\n        GREATEST(0, 1 - usage_count),\r\n        usage_count;\r\nEND;\r\n"
  },
  {
    "routine_name": "check_user_quota",
    "routine_type": "FUNCTION",
    "return_type": "record",
    "routine_definition": "\r\nDECLARE\r\n    usage_count INT;\r\nBEGIN\r\n    SELECT COUNT(*) INTO usage_count\r\n    FROM verdict_usage\r\n    WHERE user_id = p_user_id\r\n    AND used_at > NOW() - INTERVAL '24 hours';\r\n    \r\n    RETURN QUERY SELECT \r\n        usage_count < 5,\r\n        GREATEST(0, 5 - usage_count),\r\n        usage_count;\r\nEND;\r\n"
  },
  {
    "routine_name": "complete_appeal",
    "routine_type": "FUNCTION",
    "return_type": "void",
    "routine_definition": "\r\nDECLARE\r\n    v_original_winner VARCHAR(10);\r\n    v_verdict_changed BOOLEAN;\r\nBEGIN\r\n    -- Get original winner\r\n    SELECT original_winner INTO v_original_winner\r\n    FROM appeals\r\n    WHERE id = p_appeal_id;\r\n    \r\n    -- Determine if verdict changed\r\n    v_verdict_changed := (v_original_winner != p_new_winner);\r\n    \r\n    -- Update appeal record\r\n    UPDATE appeals\r\n    SET \r\n        appeal_verdict = p_appeal_verdict,\r\n        new_winner = p_new_winner,\r\n        new_party_a_score = p_new_party_a_score,\r\n        new_party_b_score = p_new_party_b_score,\r\n        verdict_changed = v_verdict_changed,\r\n        change_summary = p_change_summary,\r\n        status = 'completed',\r\n        processed_at = NOW()\r\n    WHERE id = p_appeal_id;\r\nEND;\r\n"
  },
  {
    "routine_name": "create_case",
    "routine_type": "FUNCTION",
    "return_type": "jsonb",
    "routine_definition": "\r\nDECLARE\r\n    v_case_id UUID;\r\n    v_code VARCHAR(20);\r\nBEGIN\r\n    -- Generate unique code\r\n    v_code := generate_case_code();\r\n    \r\n    -- Insert the case\r\n    INSERT INTO cases (\r\n        code,\r\n        category,\r\n        tone,\r\n        party_a_id,\r\n        party_a_name,\r\n        party_a_argument,\r\n        party_a_evidence_text,\r\n        party_a_evidence_images,\r\n        party_a_ip,\r\n        status\r\n    ) VALUES (\r\n        v_code,\r\n        p_category,\r\n        p_tone,\r\n        auth.uid(), -- NULL for anonymous\r\n        p_party_a_name,\r\n        p_party_a_argument,\r\n        p_party_a_evidence_text,\r\n        p_party_a_evidence_images,\r\n        p_party_a_ip,\r\n        'pending_response'\r\n    )\r\n    RETURNING id INTO v_case_id;\r\n    \r\n    RETURN jsonb_build_object(\r\n        'success', true,\r\n        'case_id', v_case_id,\r\n        'code', v_code\r\n    );\r\nEND;\r\n"
  },
  {
    "routine_name": "expire_old_cases",
    "routine_type": "FUNCTION",
    "return_type": "integer",
    "routine_definition": "\r\nDECLARE\r\n    expired_count INT;\r\nBEGIN\r\n    UPDATE cases \r\n    SET status = 'expired'\r\n    WHERE status = 'pending_response' \r\n    AND expires_at < NOW();\r\n    \r\n    GET DIAGNOSTICS expired_count = ROW_COUNT;\r\n    RETURN expired_count;\r\nEND;\r\n"
  },
  {
    "routine_name": "generate_case_code",
    "routine_type": "FUNCTION",
    "return_type": "character varying",
    "routine_definition": "\r\nDECLARE\r\n    new_code VARCHAR(20);\r\n    code_exists BOOLEAN;\r\n    -- Removed ambiguous characters: 0,O,1,I,L\r\n    chars TEXT := 'ABCDEFGHJKMNPQRSTUVWXYZ23456789';\r\n    result TEXT := '';\r\n    i INT;\r\nBEGIN\r\n    LOOP\r\n        result := '';\r\n        FOR i IN 1..8 LOOP\r\n            result := result || substr(chars, floor(random() * length(chars) + 1)::int, 1);\r\n        END LOOP;\r\n        \r\n        new_code := 'WR-' || EXTRACT(YEAR FROM NOW())::TEXT || '-' || result;\r\n        \r\n        SELECT EXISTS(SELECT 1 FROM cases WHERE code = new_code) INTO code_exists;\r\n        \r\n        IF NOT code_exists THEN\r\n            RETURN new_code;\r\n        END IF;\r\n    END LOOP;\r\nEND;\r\n"
  },
  {
    "routine_name": "get_case_with_verdict",
    "routine_type": "FUNCTION",
    "return_type": "record",
    "routine_definition": "\r\nBEGIN\r\n    -- Validate code format to prevent enumeration\r\n    -- Supports both old format (WR-YYYY-0000) and new format (WR-YYYY-XXXXXXXX)\r\n    IF p_code !~ '^WR-\\d{4}-[A-Z0-9]{4,8}$' THEN\r\n        RETURN;\r\n    END IF;\r\n\r\n    RETURN QUERY\r\n    SELECT \r\n        to_jsonb(c.*) AS case_data,\r\n        to_jsonb(v.*) AS verdict_data\r\n    FROM cases c\r\n    LEFT JOIN verdicts v ON v.case_id = c.id\r\n    WHERE c.code = p_code\r\n    LIMIT 1;\r\nEND;\r\n"
  },
  {
    "routine_name": "get_leaderboard",
    "routine_type": "FUNCTION",
    "return_type": "record",
    "routine_definition": "\r\nBEGIN\r\n    RETURN QUERY\r\n    SELECT \r\n        us.user_id,\r\n        us.total_wins,\r\n        us.total_cases,\r\n        us.win_rate,\r\n        us.longest_streak,\r\n        us.avg_score\r\n    FROM user_stats us\r\n    WHERE us.total_cases >= 3 -- Minimum cases for leaderboard\r\n    ORDER BY us.win_rate DESC, us.total_wins DESC\r\n    LIMIT p_limit;\r\nEND;\r\n"
  },
  {
    "routine_name": "get_user_profile",
    "routine_type": "FUNCTION",
    "return_type": "record",
    "routine_definition": "\r\nBEGIN\r\n    RETURN QUERY\r\n    SELECT \r\n        (SELECT to_jsonb(us.*) FROM user_stats us WHERE us.user_id = p_user_id) as stats,\r\n        (SELECT COALESCE(jsonb_agg(to_jsonb(ub.*) ORDER BY ub.earned_at DESC), '[]'::jsonb) \r\n         FROM user_badges ub WHERE ub.user_id = p_user_id) as badges,\r\n        (SELECT COALESCE(jsonb_agg(to_jsonb(uch.*) ORDER BY uch.created_at DESC), '[]'::jsonb) \r\n         FROM (SELECT * FROM user_case_history WHERE user_id = p_user_id ORDER BY created_at DESC LIMIT 20) uch) as recent_cases;\r\nEND;\r\n"
  },
  {
    "routine_name": "initialize_user_stats",
    "routine_type": "FUNCTION",
    "return_type": "void",
    "routine_definition": "\r\nBEGIN\r\n    INSERT INTO user_stats (user_id)\r\n    VALUES (p_user_id)\r\n    ON CONFLICT (user_id) DO NOTHING;\r\nEND;\r\n"
  },
  {
    "routine_name": "record_verdict_usage",
    "routine_type": "FUNCTION",
    "return_type": "void",
    "routine_definition": "\r\nBEGIN\r\n    INSERT INTO verdict_usage (case_id, user_id, guest_ip)\r\n    VALUES (p_case_id, p_user_id, CASE WHEN p_user_id IS NULL THEN p_guest_ip ELSE NULL END);\r\nEND;\r\n"
  },
  {
    "routine_name": "submit_appeal",
    "routine_type": "FUNCTION",
    "return_type": "uuid",
    "routine_definition": "\r\nDECLARE\r\n    v_appeal_id UUID;\r\n    v_original_verdict JSONB;\r\n    v_original_winner VARCHAR(10);\r\n    v_original_party_a_score INT;\r\n    v_original_party_b_score INT;\r\nBEGIN\r\n    -- Verify party can appeal\r\n    IF NOT can_party_appeal(p_case_id, p_appealing_party) THEN\r\n        RAISE EXCEPTION 'Party cannot appeal this case';\r\n    END IF;\r\n    \r\n    -- Get original verdict data\r\n    SELECT \r\n        jsonb_build_object(\r\n            'winner', winner,\r\n            'confidence', confidence,\r\n            'summary', summary,\r\n            'reasoning', reasoning,\r\n            'advice', advice,\r\n            'party_a_analysis', party_a_analysis,\r\n            'party_b_analysis', party_b_analysis\r\n        ),\r\n        winner,\r\n        party_a_score,\r\n        party_b_score\r\n    INTO \r\n        v_original_verdict,\r\n        v_original_winner,\r\n        v_original_party_a_score,\r\n        v_original_party_b_score\r\n    FROM verdicts\r\n    WHERE case_id = p_case_id;\r\n    \r\n    IF v_original_verdict IS NULL THEN\r\n        RAISE EXCEPTION 'No verdict found for this case';\r\n    END IF;\r\n    \r\n    -- Insert appeal\r\n    INSERT INTO appeals (\r\n        case_id,\r\n        appealing_party,\r\n        appellant_id,\r\n        reason,\r\n        new_evidence_text,\r\n        new_evidence_images,\r\n        original_verdict,\r\n        original_winner,\r\n        original_party_a_score,\r\n        original_party_b_score,\r\n        status\r\n    ) VALUES (\r\n        p_case_id,\r\n        p_appealing_party,\r\n        p_appellant_id,\r\n        p_reason,\r\n        p_new_evidence_text,\r\n        p_new_evidence_images,\r\n        v_original_verdict,\r\n        v_original_winner,\r\n        v_original_party_a_score,\r\n        v_original_party_b_score,\r\n        'pending'\r\n    ) RETURNING id INTO v_appeal_id;\r\n    \r\n    -- Update case appeal tracking\r\n    UPDATE cases\r\n    SET \r\n        appeal_count = appeal_count + 1,\r\n        party_a_appealed = CASE WHEN p_appealing_party = 'partyA' THEN TRUE ELSE party_a_appealed END,\r\n        party_b_appealed = CASE WHEN p_appealing_party = 'partyB' THEN TRUE ELSE party_b_appealed END\r\n    WHERE id = p_case_id;\r\n    \r\n    RETURN v_appeal_id;\r\nEND;\r\n"
  },
  {
    "routine_name": "submit_party_b_response",
    "routine_type": "FUNCTION",
    "return_type": "jsonb",
    "routine_definition": "\r\nDECLARE\r\n    v_case_id UUID;\r\n    v_status VARCHAR;\r\n    v_party_b_argument TEXT;\r\n    v_result JSONB;\r\nBEGIN\r\n    -- Validate code format (supports both old 4-digit and new 8-char codes)\r\n    IF p_code !~ '^WR-\\d{4}-[A-Z0-9]{4,8}$' THEN\r\n        RETURN jsonb_build_object(\r\n            'success', false,\r\n            'error', 'Invalid case code format'\r\n        );\r\n    END IF;\r\n    \r\n    -- Get case and check status\r\n    SELECT id, status, party_b_argument \r\n    INTO v_case_id, v_status, v_party_b_argument\r\n    FROM cases \r\n    WHERE code = p_code;\r\n    \r\n    -- Case not found\r\n    IF v_case_id IS NULL THEN\r\n        RETURN jsonb_build_object(\r\n            'success', false,\r\n            'error', 'Case not found'\r\n        );\r\n    END IF;\r\n    \r\n    -- Case not in pending_response status\r\n    IF v_status != 'pending_response' THEN\r\n        RETURN jsonb_build_object(\r\n            'success', false,\r\n            'error', 'Case is not accepting responses',\r\n            'status', v_status\r\n        );\r\n    END IF;\r\n    \r\n    -- Party B already responded\r\n    IF v_party_b_argument IS NOT NULL THEN\r\n        RETURN jsonb_build_object(\r\n            'success', false,\r\n            'error', 'Response already submitted'\r\n        );\r\n    END IF;\r\n    \r\n    -- Update the case with Party B's response\r\n    UPDATE cases SET\r\n        party_b_name = p_party_b_name,\r\n        party_b_argument = p_party_b_argument,\r\n        party_b_evidence_text = p_party_b_evidence_text,\r\n        party_b_evidence_images = p_party_b_evidence_images,\r\n        party_b_ip = p_party_b_ip,\r\n        party_b_id = auth.uid(), -- Will be NULL for anonymous users\r\n        responded_at = NOW(),\r\n        status = 'ready_for_verdict'\r\n    WHERE id = v_case_id;\r\n    \r\n    RETURN jsonb_build_object(\r\n        'success', true,\r\n        'case_id', v_case_id,\r\n        'message', 'Response submitted successfully'\r\n    );\r\nEND;\r\n"
  },
  {
    "routine_name": "update_case_status",
    "routine_type": "FUNCTION",
    "return_type": "void",
    "routine_definition": "\r\nDECLARE\r\n    v_valid_statuses TEXT[] := ARRAY['pending_response', 'blocked_quota', 'analyzing', 'complete', 'expired', 'ready_for_verdict'];\r\nBEGIN\r\n    -- Validate status\r\n    IF NOT (p_status = ANY(v_valid_statuses)) THEN\r\n        RAISE EXCEPTION 'Invalid status: %', p_status;\r\n    END IF;\r\n    \r\n    -- Update the case status\r\n    UPDATE cases SET\r\n        status = p_status,\r\n        completed_at = CASE WHEN p_status = 'complete' THEN NOW() ELSE completed_at END\r\n    WHERE id = p_case_id;\r\n    \r\n    IF NOT FOUND THEN\r\n        RAISE EXCEPTION 'Case not found: %', p_case_id;\r\n    END IF;\r\nEND;\r\n"
  },
  {
    "routine_name": "update_user_stats_after_verdict",
    "routine_type": "FUNCTION",
    "return_type": "void",
    "routine_definition": "\r\nDECLARE\r\n    v_current_stats user_stats%ROWTYPE;\r\n    v_new_streak INT;\r\n    v_new_streak_type VARCHAR(10);\r\n    v_category_stats JSONB;\r\n    v_wins_with_evidence INT;\r\n    v_total_with_evidence INT;\r\nBEGIN\r\n    -- Ensure user stats exist\r\n    PERFORM initialize_user_stats(p_user_id);\r\n    \r\n    -- Get current stats\r\n    SELECT * INTO v_current_stats FROM user_stats WHERE user_id = p_user_id;\r\n    \r\n    -- Calculate new streak\r\n    IF p_outcome = 'win' THEN\r\n        IF v_current_stats.streak_type = 'win' THEN\r\n            v_new_streak := v_current_stats.current_streak + 1;\r\n        ELSE\r\n            v_new_streak := 1;\r\n        END IF;\r\n        v_new_streak_type := 'win';\r\n    ELSIF p_outcome = 'loss' THEN\r\n        IF v_current_stats.streak_type = 'loss' THEN\r\n            v_new_streak := v_current_stats.current_streak + 1;\r\n        ELSE\r\n            v_new_streak := 1;\r\n        END IF;\r\n        v_new_streak_type := 'loss';\r\n    ELSE\r\n        v_new_streak := 0;\r\n        v_new_streak_type := 'none';\r\n    END IF;\r\n    \r\n    -- Update category stats\r\n    v_category_stats := v_current_stats.category_stats;\r\n    v_category_stats := jsonb_set(\r\n        v_category_stats,\r\n        ARRAY[p_category, 'total'],\r\n        to_jsonb(COALESCE((v_category_stats -> p_category ->> 'total')::int, 0) + 1)\r\n    );\r\n    \r\n    IF p_outcome = 'win' THEN\r\n        v_category_stats := jsonb_set(\r\n            v_category_stats,\r\n            ARRAY[p_category, 'wins'],\r\n            to_jsonb(COALESCE((v_category_stats -> p_category ->> 'wins')::int, 0) + 1)\r\n        );\r\n    ELSIF p_outcome = 'loss' THEN\r\n        v_category_stats := jsonb_set(\r\n            v_category_stats,\r\n            ARRAY[p_category, 'losses'],\r\n            to_jsonb(COALESCE((v_category_stats -> p_category ->> 'losses')::int, 0) + 1)\r\n        );\r\n    ELSE\r\n        v_category_stats := jsonb_set(\r\n            v_category_stats,\r\n            ARRAY[p_category, 'draws'],\r\n            to_jsonb(COALESCE((v_category_stats -> p_category ->> 'draws')::int, 0) + 1)\r\n        );\r\n    END IF;\r\n    \r\n    -- Calculate evidence win rate\r\n    SELECT \r\n        COUNT(*) FILTER (WHERE outcome = 'win' AND had_evidence),\r\n        COUNT(*) FILTER (WHERE had_evidence)\r\n    INTO v_wins_with_evidence, v_total_with_evidence\r\n    FROM user_case_history\r\n    WHERE user_id = p_user_id;\r\n    \r\n    -- Add current case to counts\r\n    IF p_had_evidence THEN\r\n        v_total_with_evidence := v_total_with_evidence + 1;\r\n        IF p_outcome = 'win' THEN\r\n            v_wins_with_evidence := v_wins_with_evidence + 1;\r\n        END IF;\r\n    END IF;\r\n    \r\n    -- Update user_stats\r\n    UPDATE user_stats SET\r\n        total_cases = total_cases + 1,\r\n        total_wins = total_wins + CASE WHEN p_outcome = 'win' THEN 1 ELSE 0 END,\r\n        total_losses = total_losses + CASE WHEN p_outcome = 'loss' THEN 1 ELSE 0 END,\r\n        total_draws = total_draws + CASE WHEN p_outcome = 'draw' THEN 1 ELSE 0 END,\r\n        win_rate = CASE \r\n            WHEN (total_cases + 1) > 0 \r\n            THEN ROUND(((total_wins + CASE WHEN p_outcome = 'win' THEN 1 ELSE 0 END)::decimal / (total_cases + 1)) * 100, 2)\r\n            ELSE 0 \r\n        END,\r\n        current_streak = v_new_streak,\r\n        longest_streak = GREATEST(v_current_stats.longest_streak, v_new_streak),\r\n        longest_win_streak = \r\n        CASE \r\n            WHEN v_new_streak_type = 'win' \r\n            THEN GREATEST(v_current_stats.longest_win_streak, v_new_streak)\r\n            ELSE v_current_stats.longest_win_streak \r\n        END,\r\n        longest_loss_streak = \r\n        CASE \r\n            WHEN v_new_streak_type = 'loss' \r\n            THEN GREATEST(v_current_stats.longest_loss_streak, v_new_streak)\r\n            ELSE v_current_stats.longest_loss_streak \r\n        END,\r\n        streak_type = v_new_streak_type,\r\n        category_stats = v_category_stats,\r\n        avg_score = ROUND(((avg_score * total_cases) + p_score) / (total_cases + 1), 2),\r\n        total_fallacies_detected = total_fallacies_detected + p_fallacies_count,\r\n        cases_with_evidence = cases_with_evidence + CASE WHEN p_had_evidence THEN 1 ELSE 0 END,\r\n        evidence_win_rate = CASE \r\n            WHEN v_total_with_evidence > 0 \r\n            THEN ROUND((v_wins_with_evidence::decimal / v_total_with_evidence) * 100, 2)\r\n            ELSE 0 \r\n        END,\r\n        updated_at = NOW()\r\n    WHERE user_id = p_user_id;\r\n    \r\n    -- Add to case history\r\n    INSERT INTO user_case_history (\r\n        user_id, case_id, case_code, role, opponent_name, \r\n        outcome, score, opponent_score, category, tone, \r\n        had_evidence, fallacies_count\r\n    ) VALUES (\r\n        p_user_id, p_case_id, p_case_code, p_role, p_opponent_name,\r\n        p_outcome, p_score, p_opponent_score, p_category, p_tone,\r\n        p_had_evidence, p_fallacies_count\r\n    ) ON CONFLICT (user_id, case_id) DO NOTHING;\r\n    \r\n    -- Check and award badges\r\n    PERFORM check_and_award_badges(p_user_id);\r\nEND;\r\n"
  }
]